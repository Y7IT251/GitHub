<!DOCTYPE html>
<html>
<head>
    <title>Identity and Access Management QRCode Reader</title>
    <script type="text/javascript" src="scripts/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="scripts/jquery.webcamqrcode.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
</head>
<body>
    <script>
        $(function () {
            $('#qrcodebox').WebcamQRCode({
                onQRCodeDecode: function (p_data) {
                    var res = [];
                    try {
                        res = p_data.split(",", 2);                        
                    } catch (e) {
                        $('#lbl_msg')[0].innerHTML = "Invalid QRCode. Use QRCode generated by IAM Mobile Application";
                    }
                    if (res[0] != undefined && res[1] != undefined) {
                        validateRequest(res[0], res[1]);
                    }
                    else
                    {
                        $('#lbl_msg')[0].innerHTML = "Invalid QRCode. Use QRCode generated by IAM Mobile Application";
                    }
                }
            });

            $('#btn_start').click(function () {
                $('#qrcodebox').WebcamQRCode().start();
            });

            $('#btn_cancel').click(function () {
                $('#qrcodebox').WebcamQRCode().stop();
            });
        });
        function validateRequest(username,domain)
        {  
            $.ajax({
                url: 'https://api.mongolab.com/api/1/databases/iamdb/collections/qrcode?apiKey=EpThFIOyjKh-WbVlIWEvG0Iq8Pkvoohg&u=true&q={"email" :"' + username + '","domain" :"' + domain + '"}',
                type: "GET",
                contentType: "application/json"
            }).success(function (data) {
                if (data.length > 0) {
                    var val = data[0].validupto;
                    alert(val);
                    alert(new Date(val).getTime());
                    alert(new Date().getTime());
                    if ((new Date(val).getTime() > new Date().getTime())) {
                        window.location.href = "dashboard.html#/" + username + '/' + domain;
                    }
                    else
                    {
                        $('#lbl_msg')[0].innerHTML = "QRCode Expired. Please generate QRcode and try again.";
                    }
                }
                else {
                    $('#lbl_msg')[0].innerHTML = "Invalid Login.";
                }
            }).error(function (data) {
                $('#lbl_msg')[0].innerHTML = "Invalid Login.";
            });
        }
    </script>

    <div class="col-md-12" style="text-align:center; background-color:aquamarine">
        <h2>Identity and Access Management</h2>
    </div>

    <div style="background-color:burlywood;height:650px">
        
        <div class="modal-header text-center">
            <br />
            <br />
            <h3>Scan Your QRCode to Login</h3>
        </div>
        <div id="qrcodebox" style="width: 450px; height: 450px; margin:10px auto">
        </div>
        <div class="text-center">
            <input type="button" class="btn-primary" id="btn_start" value="  Start  " /><span></span>
            <input type="button" class="btn-primary" id="btn_cancel" value="Cancel" />
            <br />
            <label id="lbl_msg">Hi How are YOu</label>
        </div>
    </div>

</body>
</html>
